#!/usr/bin/perl

use strict;
use warnings;
use utf8;
use HTML::Entities;
use Encode qw/encode decode/;
use File::Path 'rmtree';
use Regexp::Common qw(URI);

sub trim { my $s = shift; $s =~ s/^\s+|\s+$//g; return $s; };

binmode STDIN, ":utf8";
binmode STDOUT, ":utf8";

my ($raw_corpus_dir, $cleaned_corpus_dir) = @ARGV;

if (2 != scalar @ARGV || not defined $raw_corpus_dir || not defined $cleaned_corpus_dir) {
    print "[Usage] $0 [raw corpus directory] [cleaned corpus directory]\n";
    exit 1;
}

die "[ERROR] raw corpus directory $raw_corpus_dir does not exist\n"
    unless (-d $raw_corpus_dir);

if (-d $cleaned_corpus_dir) {
    rmtree($cleaned_corpus_dir);
}

die "[ERROR] failed to make cleaned corpus directory $cleaned_corpus_dir: $!\n"
    unless (mkdir $cleaned_corpus_dir);

# opendir(RAW_CORPUS_DIR, $raw_corpus_dir)
#     or die "[ERROR] failed to open $raw_corpus_dir: $!\n";
# opendir(CLEANED_CORPUS_DIR, $cleaned_corpus_dir)
#     or die "[ERROR] failed to open $cleaned_corpus_dir: $!\n";

open(RAW_CORPUS, "<:encoding(UTF-8)",
    "$raw_corpus_dir/kowiki-latest-pages-articles.xml")
    or die "[ERROR] failed to open kowiki-latest-pages-articles.xml: $!\n";
open(CLEANED_CORPUS, ">:encoding(UTF-8)",
    "$cleaned_corpus_dir/cleaned_korean_wiki_dumps.txt")
    or die "[ERROR] failed to open cleaned_korean_wiki_dumps.txt: $!\n";

# a hash mainly for half/full width character normalization
my %hf_width_map = (
    "¡" => " ",
    "¤" => " ",
    "¥" => " ",
    "°" => " ",
    "±" => " ",
    "²" => " ",
    "³" => " ",
    "´" => "\'",
    "·" => " ",
    "¸" => " ",
    "¹" => " ",
    "¼" => " ",
    "½" => " ",
    "Ö" => " ",
    "×" => "x",
    "Ü" => " ",
    "ß" => " ",
    "ä" => " ",
    "æ" => " ",
    "ç" => " ",
    "é" => " ",
    "ö" => " ",
    "÷" => " ",
    "ø" => " ",
    "ü" => " ",
    "ħ" => " ",
    "˚" => " ",
    "Ρ" => " ",
    "Φ" => " ",
    "α" => " ",
    "β" => " ",
    "γ" => " ",
    "δ" => " ",
    "μ" => " ",
    "ν" => " ",
    "π" => " ",
    "σ" => " ",
    "φ" => " ",
    "χ" => " ",
    "ψ" => " ",
    "е" => " ",
    "†" => " ",
    "‡" => " ",
    "‥" => " ",
    "…" => " ",
    "₁" => " ",
    "₂" => " ",
    "℃" => " ",
    "ℓ" => " ",
    "⅓" => " ",
    "⅔" => " ",
    "⅛" => " ",
    "Ⅰ" => " ",
    "Ⅱ" => " ",
    "Ⅲ" => " ",
    "Ⅳ" => " ",
    "Ⅴ" => " ",
    "Ⅵ" => " ",
    "Ⅶ" => " ",
    "Ⅷ" => " ",
    "Ⅸ" => " ",
    "Ⅹ" => " ",
    "ⅰ" => " ",
    "ⅱ" => " ",
    "ⅲ" => " ",
    "ⅳ" => " ",
    "ⅴ" => " ",
    "ⅵ" => " ",
    "ⅶ" => " ",
    "ⅹ" => " ",
    "←" => " ",
    "↑" => " ",
    "→" => " ",
    "↓" => " ",
    "↔" => " ",
    "⇒" => " ",
    "∀" => " ",
    "∃" => " ",
    "∈" => " ",
    "∧" => " ",
    "∨" => " ",
    "∴" => " ",
    "≡" => " ",
    "⊙" => " ",
    "⌒" => " ",
    "⑦" => " ",
    "⑧" => " ",
    "⑪" => " ",
    "⑫" => " ",
    "⑬" => " ",
    "⑭" => " ",
    "⑮" => " ",
    "⑴" => " ",
    "⑵" => " ",
    "⑶" => " ",
    "⑷" => " ",
    "⑸" => " ",
    "⑹" => " ",
    "⑺" => " ",
    "⑻" => " ",
    "⑼" => " ",
    "⒜" => " ",
    "⒝" => " ",
    "⒞" => " ",
    "ⓐ" => " ",
    "ⓑ" => " ",
    "ⓒ" => " ",
    "ⓓ" => " ",
    "ⓛ" => " ",
    "ⓝ" => " ",
    "┞" => " ",
    "■" => " ",
    "□" => " ",
    "▣" => " ",
    "▧" => " ",
    "▨" => " ",
    "▪" => " ",
    "△" => " ",
    "▹" => " ",
    "▼" => " ",
    "▽" => " ",
    "◁" => " ",
    "◆" => " ",
    "◇" => " ",
    "◈" => " ",
    "○" => " ",
    "◎" => " ",
    "●" => " ",
    "◦" => " ",
    "★" => " ",
    "☆" => " ",
    "☎" => " ",
    "☞" => " ",
    "♠" => " ",
    "♡" => " ",
    "♣" => " ",
    "♤" => " ",
    "♥" => " ",
    "♩" => " ",
    "♪" => " ",
    "♬" => " ",
    "❷" => " ",
    "❿" => " ",
    "➀" => " ",
    "➈" => " ",
    "➌" => " ",
    "➍" => " ",
    "➎" => " ",
    "➏" => " ",
    "ㆍ" => " ",
    "㈀" => " ",
    "㈁" => " ",
    "㈎" => " ",
    "㈏" => " ",
    "㈐" => " ",
    "㈑" => " ",
    "㈒" => " ",
    "㉠" => " ",
    "㉡" => " ",
    "㉢" => " ",
    "㉣" => " ",
    "㉤" => " ",
    "㉥" => " ",
    "㉮" => " ",
    "㉯" => " ",
    "㉰" => " ",
    "㉱" => " ",
    "㊉" => " ",
    "㎉" => " ",
    "㎍" => " ",
    "㎎" => " ",
    "㎏" => " ",
    "㎐" => " ",
    "㎑" => " ",
    "㎒" => " ",
    "㎓" => " ",
    "㎖" => " ",
    "㎗" => " ",
    "㎘" => " ",
    "㎚" => " ",
    "㎛" => " ",
    "㎜" => " ",
    "㎝" => " ",
    "㎞" => " ",
    "㎟" => " ",
    "㎠" => " ",
    "㎡" => " ",
    "㎢" => " ",
    "㎣" => " ",
    "㎤" => " ",
    "㎥" => " ",
    "㎧" => " ",
    "㎳" => " ",
    "㎾" => " ",
    "㎿" => " ",
    "㏄" => " ",
    "㏈" => " ",
    "㏊" => " ",
    "＀" => " ",
    "＿" => " ",
    "･" => " ",
    "ｦ" => " ",
    "ｧ" => " ",
    "ｨ" => " ",
    "ｩ" => " ",
    "ｪ" => " ",
    "ｫ" => " ",
    "ｬ" => " ",
    "ｭ" => " ",
    "ｮ" => " ",
    "ｯ" => " ",
    "ｰ" => " ",
    "ｱ" => " ",
    "ｲ" => " ",
    "ｳ" => " ",
    "ｴ" => " ",
    "ｵ" => " ",
    "ｶ" => " ",
    "ｷ" => " ",
    "ｸ" => " ",
    "ｹ" => " ",
    "ｺ" => " ",
    "ｻ" => " ",
    "ｼ" => " ",
    "ｽ" => " ",
    "ｾ" => " ",
    "ｿ" => " ",
    "ﾀ" => " ",
    "ﾁ" => " ",
    "ﾂ" => " ",
    "ﾃ" => " ",
    "ﾄ" => " ",
    "ﾅ" => " ",
    "ﾆ" => " ",
    "ﾇ" => " ",
    "ﾈ" => " ",
    "ﾉ" => " ",
    "ﾊ" => " ",
    "ﾋ" => " ",
    "ﾌ" => " ",
    "ﾍ" => " ",
    "ﾎ" => " ",
    "ﾏ" => " ",
    "ﾐ" => " ",
    "ﾑ" => " ",
    "ﾒ" => " ",
    "ﾓ" => " ",
    "ﾔ" => " ",
    "ﾕ" => " ",
    "ﾖ" => " ",
    "ﾗ" => " ",
    "ﾘ" => " ",
    "ﾙ" => " ",
    "ﾚ" => " ",
    "ﾛ" => " ",
    "ﾜ" => " ",
    "ﾝ" => " ",
    "ﾡ" => " ",
    "ﾢ" => " ",
    "ﾣ" => " ",
    "ﾤ" => " ",
    "ﾥ" => " ",
    "ﾦ" => " ",
    "ﾧ" => " ",
    "ﾨ" => " ",
    "ﾩ" => " ",
    "ﾪ" => " ",
    "ﾫ" => " ",
    "ﾬ" => " ",
    "ﾭ" => " ",
    "ﾮ" => " ",
    "ﾯ" => " ",
    "ﾰ" => " ",
    "ﾱ" => " ",
    "ﾲ" => " ",
    "ﾳ" => " ",
    "ﾴ" => " ",
    "ﾵ" => " ",
    "ﾶ" => " ",
    "ﾷ" => " ",
    "ﾸ" => " ",
    "ﾹ" => " ",
    "ﾺ" => " ",
    "ﾻ" => " ",
    "ﾼ" => " ",
    "ﾽ" => " ",
    "ﾾ" => " ",
    "﾿" => " ",
    "￀" => " ",
    "￁" => " ",
    "ￂ" => " ",
    "ￃ" => " ",
    "ￄ" => " ",
    "ￅ" => " ",
    "ￆ" => " ",
    "ￇ" => " ",
    "￈" => " ",
    "￉" => " ",
    "ￊ" => " ",
    "ￋ" => " ",
    "ￌ" => " ",
    "ￍ" => " ",
    "ￎ" => " ",
    "ￏ" => " ",
    "￐" => " ",
    "￑" => " ",
    "ￒ" => " ",
    "ￓ" => " ",
    "ￔ" => " ",
    "ￕ" => " ",
    "ￖ" => " ",
    "ￗ" => " ",
    "￘" => " ",
    "￙" => " ",
    "ￚ" => " ",
    "ￛ" => " ",
    "ￜ" => " ",
    "￝" => " ",
    "￞" => " ",
    "￟" => " ",
    "￠" => " ",
    "￡" => " ",
    "￢" => " ",
    "￣" => " ",
    "￤" => " ",
    "￥" => " ",
    "￦" => " ",
    "￧" => " ",
    "￩" => " ",
    "￪" => " ",
    "￫" => " ",
    "￬" => " ",
    "￭" => " ",
    "￮" => " ",
    "￯" => " ",
    "￰" => " ",
    "￱" => " ",
    "￲" => " ",
    "￳" => " ",
    "￴" => " ",
    "￵" => " ",
    "￶" => " ",
    "￷" => " ",
    "￸" => " ",
    "￹" => " ",
    "�" => " ",
    "！" => "!",
    "˝" => "\"",
    "“" => "\"",
    "”" => "\"",
    "″" => "\"",
    "〃" => "\"",
    "『" => "\"",
    "』" => "\"",
    "＂" => "\"",
    "｢" => "\"",
    "｣" => "\"",
    "＃" => "#",
    "＄" => "\$",
    "％" => "\%",
    "＆" => "\&",
    "ʹ" => "\'",
    "˙" => "\'",
    "‘" => "\'",
    "’" => "\'",
    "′" => "\'",
    "＇" => "\'",
    "｀" => "\'",
    "ﾞ" => "\'",
    "ﾟ" => "\'",
    "（" => "(",
    "｟" => "(",
    "㈜" => "(주)",
    "）" => ")",
    "｠" => ")",
    "※" => "*",
    "＊" => "*",
    "＋" => "+",
    "、" => ",",
    "，" => ",",
    "､" => ",",
    "―" => "-",
    "─" => "-",
    "－" => "-",
    "。" => ".",
    "．" => ".",
    "｡" => ".",
    "／" => "/",
    "０" => "0",
    "１" => "1",
    "２" => "2",
    "３" => "3",
    "４" => "4",
    "５" => "5",
    "６" => "6",
    "７" => "7",
    "８" => "8",
    "９" => "9",
    "ː" => ":",
    "：" => ":",
    "；" => ";",
    "≪" => "<",
    "〈" => "<",
    "《" => "<",
    "＜" => "<",
    "〓" => "=",
    "＝" => "=",
    "≫" => ">",
    "〉" => ">",
    "》" => ">",
    "＞" => ">",
    "？" => "?",
    "＠" => "@",
    "Ｖ" => "V",
    "Ｘ" => "X",
    "〔" => "[",
    "［" => "[",
    "＼" => "\\",
    "〕" => "]",
    "］" => "]",
    "＾" => "^",
    "＿" => "_",
    "Ａ" => "a",
    "ａ" => "a",
    "Ｂ" => "b",
    "ｂ" => "b",
    "Ｃ" => "c",
    "ｃ" => "c",
    "Ｄ" => "d",
    "ｄ" => "d",
    "Ｅ" => "e",
    "ｅ" => "e",
    "Ｆ" => "f",
    "ｆ" => "f",
    "Ｇ" => "g",
    "ｇ" => "g",
    "Ｈ" => "h",
    "ｈ" => "h",
    "Ｉ" => "i",
    "ｉ" => "i",
    "Ｊ" => "j",
    "ｊ" => "j",
    "Ｋ" => "k",
    "ｋ" => "k",
    "Ｌ" => "l",
    "ｌ" => "l",
    "Ｍ" => "m",
    "ｍ" => "m",
    "Ｎ" => "n",
    "ｎ" => "n",
    "Ｏ" => "o",
    "ｏ" => "o",
    "Ｐ" => "p",
    "ｐ" => "p",
    "Ｑ" => "q",
    "ｑ" => "q",
    "Ｒ" => "r",
    "ｒ" => "r",
    "Ｓ" => "s",
    "ｓ" => "s",
    "Ｔ" => "t",
    "ｔ" => "t",
    "Ｕ" => "u",
    "ｕ" => "u",
    "Ｖ" => "v",
    "ｖ" => "v",
    "Ｗ" => "w",
    "ｗ" => "w",
    "Ｘ" => "x",
    "ｘ" => "x",
    "Ｙ" => "y",
    "ｙ" => "y",
    "Ｚ" => "z",
    "ｚ" => "z",
    "｛" => "{",
    "∥" => "|",
    "│" => "|",
    "｜" => "|",
    "￨" => "|",
    "｝" => "}",
    "˜" => "~",
    "∼" => "~",
    "～" => "~",
);
my $hf_width_pat = join("|", keys %hf_width_map);

my $raw_lines = 0;
my $cleaned_lines = 0;
while (my $line = <RAW_CORPUS>) {
    $raw_lines++;
    next if ($line !~ m/\p{InHangul_Syllables}/);

    $line =~ s/^!(\p{InHangul_Syllables}+)/$1/;  # TODO
    $line =~ s/^#(\p{InHangul_Syllables}+)/$1/;  # TODO
    $line =~ s/^\(([^\(\)]+)\)$/$1/;

    # pass if with leading ! # $ % &
    next if ($line =~ m/^[!#\$%&]/);
    next if ($line =~ m/'[^']+'\s*:\s*/);

    next if ($line =~ m/^\{\{인용문\|/);

    # leading double quot(")
    $line =~ s/^\"([^\"]+)\"\s*:\s*\{.*$/$1/;

    chomp $line;
    $line =~ s/$RE{URI}{HTTP}//g;  # delete all URLs matched (not perfact though)
    $line = decode_entities($line);
    $line = decode_entities($line);  # for double-encoded cases

    # text cleaning
    #$line =~ s/\[\[([^\|\[\]]+)\|([^\|\[\]]+)\]\]/$1 $2/g;
    #$line =~ s/\[\[([^\[\]]+)\]\]/$1/g;
    #$line =~ s/(^!)?colspan[^!\|\p{Hangul}]+\|//g;
    $line =~ s/\[\[[^\[\]]*\]\]//g;
    $line =~ s/\{\{[^\{\}]*\}\}//g;
    $line =~ s/'''?([^']*)'''?/$1/g;
    #$line =~ s/(\|\|\s*\d+\s*)+//g;
    $line =~ s/([\s<>])[\p{P}\p{Hangul}a-zA-Z0-9]*[X]+(?:\s+X+)*[\p{P}\p{Hangul}a-zA-Z0-9]*([\s<>])/$1$2/g;
    $line =~ s/(\p{InHangul_Syllables})_(\p{InHangul_Syllables})/$1 $2/g;
    $line =~ s/<[^<>]+$|^[^<>]+>//g;
    $line =~ s/(<\/?(div|br|p|li|dt|dd)[^a-z]*?\/?>\s*)+/ /ig;
    $line =~ s/<[^<>]+>//g;
    $line =~ s/ / /g;  # nbsp
    $line =~ s/\x{FEFF}//g;  # zero width nbsp
    $line =~ s/ +/ /g;
=pod
    $line =~ s/!!/\n/g;
    $line =~ s/ \||\| /\n/g;
    $line =~ s/ *\n */\n/g;
    my @lines = split /\n/, $line;
    $line = "";
    foreach my $token (@lines) {
        next if ($token !~ m/\p{InHangul_Syllables}/);
        $token =~ s/ +/ /g;
        $token =~ s/^(! )+//;
        $token = trim $token;
        $line = $line."\n".$token;
    }
=cut
    $line = trim $line;
    next if ($line !~ m/\p{InHangul_Syllables}/);
    next if ($line =~ m/^\s*$/);

    print CLEANED_CORPUS $line."\n";
    $cleaned_lines++;
    print ("# lines processed: ".$cleaned_lines."\n") if ($cleaned_lines % 1000000 == 0);
}

print ("## total cleaned lines: ".$cleaned_lines." / ".$raw_lines."\n");

close(CLEANED_CORPUS);
close(RAW_CORPUS);

# closedir(CLEANED_CORPUS_DIR);
# closedir(RAW_CORPUS_DIR);

